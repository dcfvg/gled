#!/bin/bash

# glisser-editer
# USAGE: glisser-editer

content="~/Dropbox/glisser-editer"

docw=2480                     # docsize
doch=3508                     # A4 - 300dpi = 2480x3508

parchive="$content/archive"   # keeping all submission ordered by date
pinbox="$content/inbox"       # where the new files are uploaded
pprint="$content/print"       # printer files list
pstep="$content/step"         # every steps of the image in jpegs
ptrash="$content/trash"       # an incremental clone of the inbox
last="$pstep/last.jpg"        # the current wall state

for pdoc in `find $pinbox \( -iname \*.png -o  -iname \*.pdf -o -iname \*.jpg \) -type f | xargs ls -rt`
do
  
  box=$(basename $(dirname $pdoc))  # contribution path
  blin=${box:0:1}                   # sheet line number                   
  bcol=${box:2:1}                   # sheet column
  
  doc=$(basename $pdoc)             # contribution file
  
  echo "$blin:$bcol ($doc)"
  
  # get contribution timestamp
  filemtime=$(perl -MPOSIX -le 'print strftime "%s",localtime ((stat $ARGV[0])[9])' $pdoc)
  
  # resize and archive documents
  
  pdocarchive="$parchive/$filemtime.$blin-$bcol.$doc" #name of the archive file
  
  convert -format jpg -resize $docsize -extent $docw"x"$doch $pdoc \
  -gravity south \
  -stroke '#000C' -strokewidth 2 -annotate 0 "$blin:$bcol ($doc)" \
  -stroke  none   -fill white    -annotate 0 "$blin:$bcol ($doc)" \
  $pdocarchive
  
  # add current contribution to last step
  step="$pstep/$filemtime.jpg"
  composite $pdocarchive -geometry "+$((docw*bcol))+$((doch*blin))" $last $step
  
  # move form inbox to trash
  mv $pdoc "$ptrash/$box/$doc"
  
  # update last step
  rm $last
  cp $step $last
  
  # generate printable version (pdf)
  pprintpdf="$pprint/all/$filemtime.pdf"
  convert -format pdf $step $pprintpdf
  
  # copy printable version for every printers
  for printers in `find $pprint -type d 
  do
    cp $pprintpdf "$printers/$filemtime.pdf"  
  done
  
done